[% WRAPPER wrapper.html.tt %]
    <script src="/js/mapgrid.js" type="text/javascript"></script>
    <script src="/js/heatmap.js" type="text/javascript"></script>
    <script src="/js/heatmapviewer.js" type="text/javascript"></script>
    <div class="page-header">
        <h2>[% page.title %]</h2>
    </div>
    <div class="row">
        <div class="col-lg-9 col-md-9">
            <div id="map-container"></div>
        </div>
        <div class="col-lg-3 col-md-3">
        </div>
    </div>
    <script type="text/javascript">
        $(document).ready(function() {
            window.heatmapViewer = new HeatmapViewer({
                ident: '01_karelia',
                container: $('#map-container'),
            });

            $(document).ajaxError(function(e, j, a, t) {
                alert('There is no heatmap data available for this selection');
                document.location.reload();
            });

            heatmapViewer.onError(function(e) {
                $.bootstrapGrowl({
                    text: e.text,
                    delay: 40000,
                    allow_dismiss: true
                });
            });

            heatmapViewer.onDataProcess(function(data) {
                var max = 0;
                var tmp = [];
                var me = this;
                var hmd = [];
                console.log('onDataProcess start');
                data.forEach(function(d) {
                    var gc = me.getMapGrid().game_to_map_coord([ d.x, 0, d.y ]);
                    var subc = me.getMapGrid().getSubcellCenterCoordinates(gc);
                    if(d.count > max) max = d.count;
                });

                // recreate
                for(x in tmp) {
                    for(y in tmp[x]) {
                        hmd.push({ x: x, y: y, count: tmp[x][y] });
                    }
                }
                console.log('onDataProcess end');
                console.log('data set size: ', hmd.length, ' set: ', hmd, ' tmp: ', tmp);

                this._setDataSet({ max: max, data: hmd });
                this.getMapGrid().hideLoader();
            });

            heatmapViewer.onInit(function() {
                this.load();
            });
            heatmapViewer.init();
        });
    </script>
[% END %]
